# MatrixOne Distributed Cluster with Docker Compose
# Supports both official Docker Hub image and local build
#
# Usage:
# 1. Start MatrixOne cluster (all services):
#    docker compose --profile matrixone up -d
#    Or use official image (will pull from Docker Hub if not exist locally):
#    docker compose --profile matrixone up -d
#
# 2. Build from source (for developers, creates 'local' tag):
#    docker compose build
#    IMAGE_NAME=matrixorigin/matrixone:local docker compose --profile matrixone up -d
#
# 3. Start with Grafana monitoring (MatrixOne + Grafana + Prometheus):
#    docker compose --profile matrixone --profile prometheus up -d
#    Access Grafana UI at http://localhost:3000 (admin/admin)
#    Prometheus runs internally and is accessed by Grafana only
#
# 4. Start monitoring for local MatrixOne (MatrixOne runs locally, not in Docker):
#    docker compose --profile prometheus-local up -d
#    Access Grafana UI at http://localhost:3001 (admin/admin)
#    Prometheus runs internally and is accessed by Grafana only
#    Make sure your local MatrixOne has metrics enabled and listens on status-port
#    Note: This will start Prometheus (internal) and Grafana (exposed), not MatrixOne services
#
# Docker Registry Mirror (for faster image pulls):
#    If docker pull is slow, configure Docker registry mirror:
#    sudo ./setup-docker-mirror.sh
#    Or manually edit /etc/docker/daemon.json and add registry-mirrors
#
# Note: To enable metrics collection, you need to modify the service config files
# (cn1.toml, cn2.toml, tn.toml, proxy.toml) and set:
#   [observability]
#   disableMetric = false
#   enable-metric-to-prom = true
#   status-port = 7001

# Build configuration (only used when building locally)
# Local builds use tag 'local' to avoid overwriting the official 'latest' tag
x-build: &common-build
  context: ../../
  dockerfile: optools/images/Dockerfile.dev
  tags:
    - ${IMAGE_NAME:-matrixorigin/matrixone:latest}
    - matrixorigin/matrixone:local
  args:
    # Go proxy for faster dependency downloads
    # Override with: docker compose build --build-arg GOPROXY="https://goproxy.io,direct"
    GOPROXY: ${GOPROXY:-https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct}
    # Typecheck: enable type checking for ToSliceNoTypeCheck and ToSliceNoTypeCheck2
    # Default: 1 (enabled), set to 0 to disable
    TYPECHECK: ${TYPECHECK:-1}

services:
  # LogService - must start first as it contains HAKeeper
  mo-log:
    image: ${IMAGE_NAME:-matrixorigin/matrixone:latest}
    build: *common-build
    container_name: mo-log
    hostname: mo-log
    profiles:
      - matrixone
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user (macOS default: 501:20, Linux: use 1000:1000)
    entrypoint: [ "/mo-service" ]
    command: [ "-cfg", "/etc/docker-multi-cn-local-disk/log.toml" ]
    ports:
      - "32001:32001" # HAKeeper port
      - "7001:7001" # Status port
    volumes:
      - ../../mo-data:/mo-data
      - ../../logs:/logs
      - .:/etc/docker-multi-cn-local-disk:ro
      # Note: Local mo-service mount removed due to GLIBC version mismatch
      # Use image-built binary or build inside container for compatibility
    environment:
      - TZ=Asia/Shanghai
    networks:
      - matrixone-net
    healthcheck:
      test: [ "CMD-SHELL", "pgrep mo-service || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # TN - Transaction Node
  mo-tn:
    image: ${IMAGE_NAME:-matrixorigin/matrixone:latest}
    container_name: mo-tn
    hostname: mo-tn
    profiles:
      - matrixone
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user (macOS default: 501:20, Linux: use 1000:1000)
    entrypoint: [ "/mo-service" ]
    command: [ "-cfg", "/etc/docker-multi-cn-local-disk/tn.toml" ]
    cap_add:
      - NET_ADMIN # Required for network chaos testing with tc (traffic control)
    volumes:
      - ../../mo-data:/mo-data
      - ../../logs:/logs
      - .:/etc/docker-multi-cn-local-disk:ro
      # Note: Local mo-service mount removed due to GLIBC version mismatch
      # Use image-built binary or build inside container for compatibility
    environment:
      - TZ=Asia/Shanghai
    networks:
      - matrixone-net
    depends_on:
      mo-log:
        condition: service_healthy

  # CN1 - Compute Node 1
  mo-cn1:
    image: ${IMAGE_NAME:-matrixorigin/matrixone:latest}
    container_name: mo-cn1
    hostname: mo-cn1
    profiles:
      - matrixone
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user (macOS default: 501:20, Linux: use 1000:1000)
    entrypoint: [ "/mo-service" ]
    command: [ "-cfg", "/etc/docker-multi-cn-local-disk/cn1.toml" ]
    cap_add:
      - NET_ADMIN # Required for network chaos testing with tc (traffic control)
    ports:
      - "16001:16001" # SQL port
    volumes:
      - ../../mo-data:/mo-data
      - ../../logs:/logs
      - .:/etc/docker-multi-cn-local-disk:ro
      # Note: Local mo-service mount removed due to GLIBC version mismatch
      # Use image-built binary or build inside container for compatibility
    environment:
      - TZ=Asia/Shanghai
    networks:
      - matrixone-net
    depends_on:
      mo-log:
        condition: service_healthy

  # CN2 - Compute Node 2
  mo-cn2:
    image: ${IMAGE_NAME:-matrixorigin/matrixone:latest}
    container_name: mo-cn2
    hostname: mo-cn2
    profiles:
      - matrixone
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user (macOS default: 501:20, Linux: use 1000:1000)
    entrypoint: [ "/mo-service" ]
    command: [ "-cfg", "/etc/docker-multi-cn-local-disk/cn2.toml" ]
    cap_add:
      - NET_ADMIN # Required for network chaos testing with tc (traffic control)
    ports:
      - "16002:16002" # SQL port
    volumes:
      - ../../mo-data:/mo-data
      - ../../logs:/logs
      - .:/etc/docker-multi-cn-local-disk:ro
      # Note: Local mo-service mount removed due to GLIBC version mismatch
      # Use image-built binary or build inside container for compatibility
    environment:
      - TZ=Asia/Shanghai
    networks:
      - matrixone-net
    depends_on:
      mo-log:
        condition: service_healthy

  # Proxy - Load Balancer
  mo-proxy:
    image: ${IMAGE_NAME:-matrixorigin/matrixone:latest}
    container_name: mo-proxy
    hostname: mo-proxy
    profiles:
      - matrixone
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user (macOS default: 501:20, Linux: use 1000:1000)
    entrypoint: [ "/mo-service" ]
    command: [ "-cfg", "/etc/docker-multi-cn-local-disk/proxy.toml" ]
    ports:
      - "6001:6009" # Proxy SQL port (host:container)
    volumes:
      - ../../mo-data:/mo-data
      - ../../logs:/logs
      - .:/etc/docker-multi-cn-local-disk:ro
      # Note: Local mo-service mount removed due to GLIBC version mismatch
      # Use image-built binary or build inside container for compatibility
    environment:
      - TZ=Asia/Shanghai
    networks:
      - matrixone-net
    depends_on:
      mo-log:
        condition: service_healthy

  # Prometheus - Monitoring (optional, use --profile prometheus to enable)
  # Prometheus runs internally and is accessed by Grafana only
  prometheus:
    image: prom/prometheus:latest
    container_name: mo-prometheus
    hostname: mo-prometheus
    profiles:
      - prometheus
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user (macOS default: 501:20, Linux: use 1000:1000)
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    # Prometheus port is NOT exposed - only accessible via Docker network (for Grafana)
    # Uncomment the following line if you need direct Prometheus access:
    # ports:
    #   - "9090:9090"    # Prometheus web UI (only if needed for debugging)
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../../prometheus-data:/prometheus # Local directory for easy access
    networks:
      - matrixone-net
    depends_on:
      - mo-log
      - mo-tn
      - mo-cn1
      - mo-cn2
      - mo-proxy
    restart: unless-stopped

  # Grafana - Visualization dashboard for MatrixOne cluster
  # This is the main entry point for monitoring - Prometheus runs internally
  # Grafana connects to Prometheus via Docker network (prometheus:9090)
  grafana:
    image: grafana/grafana:latest
    container_name: mo-grafana
    hostname: mo-grafana
    profiles:
      - prometheus
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user
    ports:
      - "3000:3000" # Grafana web UI - main monitoring interface
    volumes:
      - ../../grafana-data:/var/lib/grafana # Grafana data directory
      - ./grafana-provisioning/datasources/prometheus-cluster.yml:/etc/grafana/provisioning/datasources/prometheus.yml:ro # Prometheus data source for cluster
      - ./grafana-provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro # Dashboard provisioning
      - ../../pkg/util/metric/dashboard:/var/lib/grafana/dashboards/matrixone:ro # MatrixOne dashboards
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_USERS_ALLOW_SIGN_UP=false
      - TZ=Asia/Shanghai
    networks:
      - matrixone-net
    depends_on:
      - prometheus
    restart: unless-stopped

  # Prometheus for Local MatrixOne - Monitoring local (non-Docker) services
  # This service runs internally and is accessed by Grafana only
  # Prometheus is not exposed externally - use Grafana UI instead
  prometheus-local:
    image: prom/prometheus:latest
    container_name: mo-prometheus-local
    hostname: mo-prometheus-local
    profiles:
      - prometheus-local
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user (macOS default: 501:20, Linux: use 1000:1000)
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    # Prometheus port is NOT exposed - only accessible via Docker network (for Grafana)
    # Uncomment the following line if you need direct Prometheus access:
    # ports:
    #   - "9091:9090"    # Prometheus web UI (only if needed for debugging)
    volumes:
      - ./prometheus-local.yml:/etc/prometheus/prometheus.yml:ro
      - ../../prometheus-local-data:/prometheus # Local directory for easy access
    # Use host network on Linux for better host access, or bridge with extra_hosts
    # For Linux, we'll use extra_hosts to map host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway" # Linux support for host.docker.internal
    networks:
      - matrixone-net
    environment:
      - TZ=Asia/Shanghai
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/ready" ]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # Grafana for Local MatrixOne - Visualization dashboard
  # This is the main entry point for monitoring
  # If HOST_PROMETHEUS_PORT is set, connects to host Prometheus, otherwise uses prometheus-local
  grafana-local:
    image: grafana/grafana:latest
    container_name: mo-grafana-local
    hostname: mo-grafana-local
    profiles:
      - prometheus-local
    user: "${DOCKER_UID:-501}:${DOCKER_GID:-20}" # Run as current user
    ports:
      - "3001:3000" # Grafana web UI - main monitoring interface
    volumes:
      - ../../grafana-local-data:/var/lib/grafana # Grafana data directory
      - ./grafana-provisioning/datasources/prometheus.yml:/etc/grafana/provisioning/datasources/prometheus.yml:ro # Prometheus data source for local
      - ./grafana-provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro # Dashboard provisioning
      - ../../pkg/util/metric/dashboard:/var/lib/grafana/dashboards/matrixone:ro # MatrixOne dashboards
    extra_hosts:
      - "host.docker.internal:host-gateway" # Linux support for host.docker.internal
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_USERS_ALLOW_SIGN_UP=false
      - TZ=Asia/Shanghai
      - HOST_PROMETHEUS_PORT=${HOST_PROMETHEUS_PORT:-} # Host Prometheus port (default: use prometheus-local)
    networks:
      - matrixone-net
    depends_on:
      - prometheus-local
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:3000/api/health || exit 1" ]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 10s
    restart: unless-stopped

networks:
  matrixone-net:
    driver: bridge

volumes:
  mo-data:
  logs:
    # Prometheus data is stored in local directories (../../prometheus-data and ../../prometheus-local-data)
    # instead of Docker volumes for easier access and management

