-- @suite
-- @setup
drop table if exists t_format_test;
create table t_format_test (
    id int,
    dt0 datetime(0),
    dt3 datetime(3),
    dt6 datetime(6),
    ts0 timestamp(0),
    ts6 timestamp(6),
    t0 time(0),
    t6 time(6)
);

insert into t_format_test values (
    1,
    '2022-07-01 10:20:30',
    '2022-07-01 10:20:30.123',
    '2022-07-01 10:20:30.123456',
    '2022-07-01 10:20:30',
    '2022-07-01 10:20:30.123456',
    '10:20:30',
    '10:20:30.123456'
);

-- @case
-- @desc:test for output format verification (compatible with MySQL 8.0)
-- Verify output format (should match MySQL 8.0)
select * from t_format_test;
-- Expected output format:
-- dt0: '2022-07-01 10:20:30' (no microseconds, no decimal point)
-- dt3: '2022-07-01 10:20:30.123' (3 digits microseconds)
-- dt6: '2022-07-01 10:20:30.123456' (6 digits microseconds, NOT 9 digits)
-- ts0: '2022-07-01 10:20:30' (no microseconds)
-- ts6: '2022-07-01 10:20:30.123456' (6 digits microseconds, NOT 9 digits)
-- t0: '10:20:30' (no microseconds)
-- t6: '10:20:30.123456' (6 digits microseconds, NOT 9 digits)

-- @case
-- @desc:test for format consistency in SELECT
select 
    dt0, dt3, dt6,
    ts0, ts6,
    t0, t6
from t_format_test;

-- @teardown
drop table if exists t_format_test;

-- @suite
-- @setup
drop table if exists t_format_timezone;
create table t_format_timezone (
    id int,
    ts6 timestamp(6)
);

set time_zone = 'UTC';
insert into t_format_timezone values (1, '2022-07-01 11:11:11.123456');

-- @case
-- @desc:test for output format after timezone conversion
-- Verify that scale is preserved after timezone conversion
set time_zone = 'UTC';
select ts6 from t_format_timezone;
-- Expected: '2022-07-01 11:11:11.123456' (6 digits)

set time_zone = '+08:00';
select ts6 from t_format_timezone;
-- Expected: '2022-07-01 19:11:11.123456' (6 digits, NOT 9 digits)
-- Verify: timezone conversion should preserve scale (6 digits)

-- @teardown
drop table if exists t_format_timezone;
set time_zone = '+00:00';

-- @suite
-- @case
-- @desc:test for function return value format pattern verification
-- Show original values and verify format patterns
-- @ignore:0,1,2,3,4,5,6,7,8,9
select 
    value_now_0,
    value_now_3,
    value_now_6,
    value_current_timestamp_0,
    value_current_timestamp_3,
    value_current_timestamp_6,
    value_utc_timestamp_no_scale,
    value_utc_timestamp_0,
    value_utc_timestamp_3,
    value_utc_timestamp_6,
    locate('.', value_now_0) as has_dot_now_0,
    locate('.', value_now_3) as dot_pos_now_3,
    locate('.', value_now_6) as dot_pos_now_6,
    locate('.', value_current_timestamp_0) as has_dot_current_timestamp_0,
    locate('.', value_current_timestamp_3) as dot_pos_current_timestamp_3,
    locate('.', value_current_timestamp_6) as dot_pos_current_timestamp_6,
    locate('.', value_utc_timestamp_no_scale) as has_dot_utc_timestamp_no_scale,
    locate('.', value_utc_timestamp_0) as has_dot_utc_timestamp_0,
    locate('.', value_utc_timestamp_3) as dot_pos_utc_timestamp_3,
    locate('.', value_utc_timestamp_6) as dot_pos_utc_timestamp_6,
    char_length(value_now_0) as len_now_0,
    char_length(value_now_3) - locate('.', value_now_3) as decimal_digits_now_3,
    char_length(value_now_6) - locate('.', value_now_6) as decimal_digits_now_6,
    char_length(value_current_timestamp_0) as len_current_timestamp_0,
    char_length(value_current_timestamp_3) - locate('.', value_current_timestamp_3) as decimal_digits_current_timestamp_3,
    char_length(value_current_timestamp_6) - locate('.', value_current_timestamp_6) as decimal_digits_current_timestamp_6,
    char_length(value_utc_timestamp_no_scale) as len_utc_timestamp_no_scale,
    char_length(value_utc_timestamp_0) as len_utc_timestamp_0,
    char_length(value_utc_timestamp_3) - locate('.', value_utc_timestamp_3) as decimal_digits_utc_timestamp_3,
    char_length(value_utc_timestamp_6) - locate('.', value_utc_timestamp_6) as decimal_digits_utc_timestamp_6,
    substring(value_now_3, locate('.', value_now_3) + 4) as last_6_digits_now_3,
    substring(value_now_6, locate('.', value_now_6) + 7) as last_3_digits_now_6,
    substring(value_current_timestamp_3, locate('.', value_current_timestamp_3) + 4) as last_6_digits_current_timestamp_3,
    substring(value_current_timestamp_6, locate('.', value_current_timestamp_6) + 7) as last_3_digits_current_timestamp_6,
    substring(value_utc_timestamp_3, locate('.', value_utc_timestamp_3) + 4) as last_6_digits_utc_timestamp_3,
    substring(value_utc_timestamp_6, locate('.', value_utc_timestamp_6) + 7) as last_3_digits_utc_timestamp_6
from (
    select 
        now(0) as value_now_0,
        now(3) as value_now_3,
        now(6) as value_now_6,
        current_timestamp(0) as value_current_timestamp_0,
        current_timestamp(3) as value_current_timestamp_3,
        current_timestamp(6) as value_current_timestamp_6,
        utc_timestamp() as value_utc_timestamp_no_scale,
        utc_timestamp(0) as value_utc_timestamp_0,
        utc_timestamp(3) as value_utc_timestamp_3,
        utc_timestamp(6) as value_utc_timestamp_6
) as t;

-- @case
-- @desc:test for format in expressions
select 
    date_add('2022-07-01 10:20:30.123456', interval 1 microsecond),
    date_sub('2022-07-01 10:20:30.123456', interval 1 microsecond)
;
-- All should maintain 6-digit microsecond precision

-- @bvt:issue#22956
select 
    date_add('2022-07-01 10:20:30.123456', interval 1 microsecond),
    timestampadd(microsecond, 1, '2022-07-01 10:20:30.123456'),
    date_sub('2022-07-01 10:20:30.123456', interval 1 microsecond)
;
-- @bvt:issue

