drop database if exists join_test;
create database join_test;
use join_test;
drop table if exists t;
create table t (a int, b int, j json);
insert into t values(1,3,'{"foo":1,"bar":2}'),(2,-2,'{"foo":11,"bar":22}');
select * from t;
â¤ a[4,32,0]  Â¦  b[4,32,0]  Â¦  j[-1,2147483647,0]  ğ„€
1  Â¦  3  Â¦  {"bar": 2, "foo": 1}  ğ„€
2  Â¦  -2  Â¦  {"bar": 22, "foo": 11}
select t.a,t.b,tf.* from t cross apply generate_series(t.a, t.b) tf;
â¤ a[4,32,0]  Â¦  b[4,32,0]  Â¦  result[-5,64,0]  ğ„€
1  Â¦  3  Â¦  1  ğ„€
1  Â¦  3  Â¦  2  ğ„€
1  Â¦  3  Â¦  3  ğ„€
2  Â¦  -2  Â¦  2  ğ„€
2  Â¦  -2  Â¦  1  ğ„€
2  Â¦  -2  Â¦  0  ğ„€
2  Â¦  -2  Â¦  -1  ğ„€
2  Â¦  -2  Â¦  -2
select t.a,t.b,tf.* from t cross apply generate_series(t.a, t.b) tf where t.a>1;
â¤ a[4,32,0]  Â¦  b[4,32,0]  Â¦  result[-5,64,0]  ğ„€
2  Â¦  -2  Â¦  2  ğ„€
2  Â¦  -2  Â¦  1  ğ„€
2  Â¦  -2  Â¦  0  ğ„€
2  Â¦  -2  Â¦  -1  ğ„€
2  Â¦  -2  Â¦  -2
select t.a,tmp.* from t cross apply unnest(t.j,'$') tmp;
â¤ a[4,32,0]  Â¦  col[12,-1,0]  Â¦  seq[4,32,0]  Â¦  key[12,-1,0]  Â¦  path[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  Â¦  this[-1,2147483647,0]  ğ„€
1  Â¦  t.j  Â¦  0  Â¦  bar  Â¦  $.bar  Â¦  null  Â¦  2  Â¦  {"bar": 2, "foo": 1}  ğ„€
1  Â¦  t.j  Â¦  1  Â¦  foo  Â¦  $.foo  Â¦  null  Â¦  1  Â¦  {"bar": 2, "foo": 1}  ğ„€
2  Â¦  t.j  Â¦  0  Â¦  bar  Â¦  $.bar  Â¦  null  Â¦  22  Â¦  {"bar": 22, "foo": 11}  ğ„€
2  Â¦  t.j  Â¦  1  Â¦  foo  Â¦  $.foo  Â¦  null  Â¦  11  Â¦  {"bar": 22, "foo": 11}
drop table t;
drop table if exists jt;
create table jt (id int, tags json, metrics json);
insert into jt values (1, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (2, '{"tag1": "v1", "tag2": "v22", "tag3": "v23"}', '{"m1": 12, "m2": 22, "m3": 32}');
insert into jt values (3, '{"tag13": "v13", "tag23": "v23", "tag33": "v33"}', '{"m1": 13, "m2": 23, "m3": 33}');
insert into jt values (4, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (5, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (6, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (7, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (8, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (9, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (10, '{"tag1": "v1", "tag2": "v2", "tag3", "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
invalid input: json text {"tag1": "v1", "tag2": "v2", "tag3", "v3"}
insert into jt values (11, '{"tag1": "v1", "tag2": "v2", "tag3": "v3"}', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (12, '{"tag1": "v1", "tag2": "v22", "tag3": "v23"}', '{"m1": 12, "m2": 22, "m3": 32}');
insert into jt values (13, '{"tag13": "v13", "tag23": "v23", "tag33": "v33"}', '{"m1": 13, "m2": 23, "m3": 33}');
insert into jt values (14, '[1, 2, 3]', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (15, '["v1", "v2", "v3"]', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (16, 'null', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (17, '"string"', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (18, '1', '{"m1": 1, "m2": 2, "m3": 3}');
insert into jt values (20, null, '{"m1": 1, "m2": 2, "m3": 3}');
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(tags, '$') u where id < 5;
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  ğ„€
1  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
1  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
1  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
2  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
2  Â¦  tag2  Â¦  null  Â¦  "v22"  ğ„€
2  Â¦  tag3  Â¦  null  Â¦  "v23"  ğ„€
3  Â¦  tag13  Â¦  null  Â¦  "v13"  ğ„€
3  Â¦  tag23  Â¦  null  Â¦  "v23"  ğ„€
3  Â¦  tag33  Â¦  null  Â¦  "v33"  ğ„€
4  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
4  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
4  Â¦  tag3  Â¦  null  Â¦  "v3"
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(tags, '$') u;
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  ğ„€
1  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
1  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
1  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
2  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
2  Â¦  tag2  Â¦  null  Â¦  "v22"  ğ„€
2  Â¦  tag3  Â¦  null  Â¦  "v23"  ğ„€
3  Â¦  tag13  Â¦  null  Â¦  "v13"  ğ„€
3  Â¦  tag23  Â¦  null  Â¦  "v23"  ğ„€
3  Â¦  tag33  Â¦  null  Â¦  "v33"  ğ„€
4  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
4  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
4  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
5  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
5  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
5  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
6  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
6  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
6  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
7  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
7  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
7  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
8  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
8  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
8  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
9  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
9  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
9  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
11  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
11  Â¦  tag2  Â¦  null  Â¦  "v2"  ğ„€
11  Â¦  tag3  Â¦  null  Â¦  "v3"  ğ„€
12  Â¦  tag1  Â¦  null  Â¦  "v1"  ğ„€
12  Â¦  tag2  Â¦  null  Â¦  "v22"  ğ„€
12  Â¦  tag3  Â¦  null  Â¦  "v23"  ğ„€
13  Â¦  tag13  Â¦  null  Â¦  "v13"  ğ„€
13  Â¦  tag23  Â¦  null  Â¦  "v23"  ğ„€
13  Â¦  tag33  Â¦  null  Â¦  "v33"  ğ„€
14  Â¦  null  Â¦  0  Â¦  1  ğ„€
14  Â¦  null  Â¦  1  Â¦  2  ğ„€
14  Â¦  null  Â¦  2  Â¦  3  ğ„€
15  Â¦  null  Â¦  0  Â¦  "v1"  ğ„€
15  Â¦  null  Â¦  1  Â¦  "v2"  ğ„€
15  Â¦  null  Â¦  2  Â¦  "v3"
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(metrics, '$') u;
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  ğ„€
1  Â¦  m1  Â¦  null  Â¦  1  ğ„€
1  Â¦  m2  Â¦  null  Â¦  2  ğ„€
1  Â¦  m3  Â¦  null  Â¦  3  ğ„€
2  Â¦  m1  Â¦  null  Â¦  12  ğ„€
2  Â¦  m2  Â¦  null  Â¦  22  ğ„€
2  Â¦  m3  Â¦  null  Â¦  32  ğ„€
3  Â¦  m1  Â¦  null  Â¦  13  ğ„€
3  Â¦  m2  Â¦  null  Â¦  23  ğ„€
3  Â¦  m3  Â¦  null  Â¦  33  ğ„€
4  Â¦  m1  Â¦  null  Â¦  1  ğ„€
4  Â¦  m2  Â¦  null  Â¦  2  ğ„€
4  Â¦  m3  Â¦  null  Â¦  3  ğ„€
5  Â¦  m1  Â¦  null  Â¦  1  ğ„€
5  Â¦  m2  Â¦  null  Â¦  2  ğ„€
5  Â¦  m3  Â¦  null  Â¦  3  ğ„€
6  Â¦  m1  Â¦  null  Â¦  1  ğ„€
6  Â¦  m2  Â¦  null  Â¦  2  ğ„€
6  Â¦  m3  Â¦  null  Â¦  3  ğ„€
7  Â¦  m1  Â¦  null  Â¦  1  ğ„€
7  Â¦  m2  Â¦  null  Â¦  2  ğ„€
7  Â¦  m3  Â¦  null  Â¦  3  ğ„€
8  Â¦  m1  Â¦  null  Â¦  1  ğ„€
8  Â¦  m2  Â¦  null  Â¦  2  ğ„€
8  Â¦  m3  Â¦  null  Â¦  3  ğ„€
9  Â¦  m1  Â¦  null  Â¦  1  ğ„€
9  Â¦  m2  Â¦  null  Â¦  2  ğ„€
9  Â¦  m3  Â¦  null  Â¦  3  ğ„€
11  Â¦  m1  Â¦  null  Â¦  1  ğ„€
11  Â¦  m2  Â¦  null  Â¦  2  ğ„€
11  Â¦  m3  Â¦  null  Â¦  3  ğ„€
12  Â¦  m1  Â¦  null  Â¦  12  ğ„€
12  Â¦  m2  Â¦  null  Â¦  22  ğ„€
12  Â¦  m3  Â¦  null  Â¦  32  ğ„€
13  Â¦  m1  Â¦  null  Â¦  13  ğ„€
13  Â¦  m2  Â¦  null  Â¦  23  ğ„€
13  Â¦  m3  Â¦  null  Â¦  33  ğ„€
14  Â¦  m1  Â¦  null  Â¦  1  ğ„€
14  Â¦  m2  Â¦  null  Â¦  2  ğ„€
14  Â¦  m3  Â¦  null  Â¦  3  ğ„€
15  Â¦  m1  Â¦  null  Â¦  1  ğ„€
15  Â¦  m2  Â¦  null  Â¦  2  ğ„€
15  Â¦  m3  Â¦  null  Â¦  3  ğ„€
16  Â¦  m1  Â¦  null  Â¦  1  ğ„€
16  Â¦  m2  Â¦  null  Â¦  2  ğ„€
16  Â¦  m3  Â¦  null  Â¦  3  ğ„€
17  Â¦  m1  Â¦  null  Â¦  1  ğ„€
17  Â¦  m2  Â¦  null  Â¦  2  ğ„€
17  Â¦  m3  Â¦  null  Â¦  3  ğ„€
18  Â¦  m1  Â¦  null  Â¦  1  ğ„€
18  Â¦  m2  Â¦  null  Â¦  2  ğ„€
18  Â¦  m3  Â¦  null  Â¦  3  ğ„€
20  Â¦  m1  Â¦  null  Â¦  1  ğ„€
20  Â¦  m2  Â¦  null  Â¦  2  ğ„€
20  Â¦  m3  Â¦  null  Â¦  3
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(tags, '$') u where id = 19;
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(tags, '$') u where id = 20;
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(metrics, '$') u where u.`key` = 'm2';
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  ğ„€
1  Â¦  m2  Â¦  null  Â¦  2  ğ„€
2  Â¦  m2  Â¦  null  Â¦  22  ğ„€
3  Â¦  m2  Â¦  null  Â¦  23  ğ„€
4  Â¦  m2  Â¦  null  Â¦  2  ğ„€
5  Â¦  m2  Â¦  null  Â¦  2  ğ„€
6  Â¦  m2  Â¦  null  Â¦  2  ğ„€
7  Â¦  m2  Â¦  null  Â¦  2  ğ„€
8  Â¦  m2  Â¦  null  Â¦  2  ğ„€
9  Â¦  m2  Â¦  null  Â¦  2  ğ„€
11  Â¦  m2  Â¦  null  Â¦  2  ğ„€
12  Â¦  m2  Â¦  null  Â¦  22  ğ„€
13  Â¦  m2  Â¦  null  Â¦  23  ğ„€
14  Â¦  m2  Â¦  null  Â¦  2  ğ„€
15  Â¦  m2  Â¦  null  Â¦  2  ğ„€
16  Â¦  m2  Â¦  null  Â¦  2  ğ„€
17  Â¦  m2  Â¦  null  Â¦  2  ğ„€
18  Â¦  m2  Â¦  null  Â¦  2  ğ„€
20  Â¦  m2  Â¦  null  Â¦  2
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(metrics, '$') u where u.`key` = 'm2' and u.value > 2;
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  ğ„€
2  Â¦  m2  Â¦  null  Â¦  22  ğ„€
3  Â¦  m2  Â¦  null  Â¦  23  ğ„€
12  Â¦  m2  Â¦  null  Â¦  22  ğ„€
13  Â¦  m2  Â¦  null  Â¦  23
select id, u.`key`, u.`index`, u.value from jt cross apply unnest(metrics, '$') u where u.`key` = 'm2' and json_extract_float64(u.value, '$') > 2;
â¤ id[4,32,0]  Â¦  key[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  ğ„€
2  Â¦  m2  Â¦  null  Â¦  22  ğ„€
3  Â¦  m2  Â¦  null  Â¦  23  ğ„€
12  Â¦  m2  Â¦  null  Â¦  22  ğ„€
13  Â¦  m2  Â¦  null  Â¦  23
select count(*) from jt cross apply unnest(tags, '$') u where id < 10;
â¤ count(*)[-5,64,0]  ğ„€
27
select count(*) from jt cross apply unnest(tags, '$') u where id = 2;
â¤ count(*)[-5,64,0]  ğ„€
3
select count(*) from jt cross apply unnest(tags, '$') u;
â¤ count(*)[-5,64,0]  ğ„€
42
select count(*) from jt cross apply unnest(tags, '$') u where id = 19;
â¤ count(*)[-5,64,0]  ğ„€
0
select count(*) from jt cross apply unnest(tags, '$') u where id = 20;
â¤ count(*)[-5,64,0]  ğ„€
0
drop table jt;
drop table if exists t1;
create table t1(a int, b int);
insert into t1 values(1,3),(1,-1);
select * from t1 cross apply generate_series(t1.a,t1.b,1)g;
â¤ a[4,32,0]  Â¦  b[4,32,0]  Â¦  result[-5,64,0]  ğ„€
1  Â¦  3  Â¦  1  ğ„€
1  Â¦  3  Â¦  2  ğ„€
1  Â¦  3  Â¦  3
select * from t1 outer apply generate_series(t1.a,t1.b,1)g;
â¤ a[4,32,0]  Â¦  b[4,32,0]  Â¦  result[-5,64,0]  ğ„€
1  Â¦  3  Â¦  1  ğ„€
1  Â¦  3  Â¦  2  ğ„€
1  Â¦  3  Â¦  3  ğ„€
1  Â¦  -1  Â¦  null
select * from t1 cross apply generate_series(t1.a,t1.b,-1)g;
â¤ a[4,32,0]  Â¦  b[4,32,0]  Â¦  result[-5,64,0]  ğ„€
1  Â¦  -1  Â¦  1  ğ„€
1  Â¦  -1  Â¦  0  ğ„€
1  Â¦  -1  Â¦  -1
select * from t1 outer apply generate_series(t1.a,t1.b,-1)g;
â¤ a[4,32,0]  Â¦  b[4,32,0]  Â¦  result[-5,64,0]  ğ„€
1  Â¦  3  Â¦  null  ğ„€
1  Â¦  -1  Â¦  1  ğ„€
1  Â¦  -1  Â¦  0  ğ„€
1  Â¦  -1  Â¦  -1
drop table t1;
drop table if exists t2;
create table t2(id int,j json);
insert into t2 values(1,'{"tag1": "v1", "tag2": "v2", "tag3": "v3"}');
insert into t2 values(2,null);
select t2.id,tf.* from t2 cross apply unnest(t2.j,'$')tf;
â¤ id[4,32,0]  Â¦  col[12,-1,0]  Â¦  seq[4,32,0]  Â¦  key[12,-1,0]  Â¦  path[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  Â¦  this[-1,2147483647,0]  ğ„€
1  Â¦  t2.j  Â¦  0  Â¦  tag1  Â¦  $.tag1  Â¦  null  Â¦  "v1"  Â¦  {"tag1": "v1", "tag2": "v2", "tag3": "v3"}  ğ„€
1  Â¦  t2.j  Â¦  1  Â¦  tag2  Â¦  $.tag2  Â¦  null  Â¦  "v2"  Â¦  {"tag1": "v1", "tag2": "v2", "tag3": "v3"}  ğ„€
1  Â¦  t2.j  Â¦  2  Â¦  tag3  Â¦  $.tag3  Â¦  null  Â¦  "v3"  Â¦  {"tag1": "v1", "tag2": "v2", "tag3": "v3"}
select t2.id,tf.* from t2 outer apply unnest(t2.j,'$')tf;
â¤ id[4,32,0]  Â¦  col[12,-1,0]  Â¦  seq[4,32,0]  Â¦  key[12,-1,0]  Â¦  path[12,-1,0]  Â¦  index[4,32,0]  Â¦  value[-1,2147483647,0]  Â¦  this[-1,2147483647,0]  ğ„€
1  Â¦  t2.j  Â¦  0  Â¦  tag1  Â¦  $.tag1  Â¦  null  Â¦  "v1"  Â¦  {"tag1": "v1", "tag2": "v2", "tag3": "v3"}  ğ„€
1  Â¦  t2.j  Â¦  1  Â¦  tag2  Â¦  $.tag2  Â¦  null  Â¦  "v2"  Â¦  {"tag1": "v1", "tag2": "v2", "tag3": "v3"}  ğ„€
1  Â¦  t2.j  Â¦  2  Â¦  tag3  Â¦  $.tag3  Â¦  null  Â¦  "v3"  Â¦  {"tag1": "v1", "tag2": "v2", "tag3": "v3"}  ğ„€
2  Â¦  null  Â¦  null  Â¦  null  Â¦  null  Â¦  null  Â¦  null  Â¦  null
drop table if exists t1;
create table t1(a int, b int, c int);
insert into t1 values(1, 1, NULL);
select * from t1 cross apply generate_series(t1.a,t1.b,t1.c)g;
invalid input: the value of generate_series step can't be NULL
drop table t1;
create table t1(a int, b int, c int);
insert into t1 values(1, NULL, 1);
select * from t1 cross apply generate_series(t1.a,t1.b,t1.c)g;
invalid input: the value of generate_series end can't be NULL
drop table t1;
create table t1(a int, b int, c int);
insert into t1 values(NULL, 1, 1);
select * from t1 cross apply generate_series(t1.a,t1.b,t1.c)g;
invalid input: the value of generate_series start can't be NULL
drop table t1;
create table t1(a bigint, b bigint, c bigint);
insert into t1 values(1, 1, NULL);
select * from t1 cross apply generate_series(t1.a,t1.b,t1.c)g;
invalid input: the value of generate_series step can't be NULL
drop table t1;
create table t1(a bigint, b bigint, c bigint);
insert into t1 values(1, NULL, 1);
select * from t1 cross apply generate_series(t1.a,t1.b,t1.c)g;
invalid input: the value of generate_series end can't be NULL
drop table t1;
create table t1(a bigint, b bigint, c bigint);
insert into t1 values(NULL, 1, 1);
select * from t1 cross apply generate_series(t1.a,t1.b,t1.c)g;
invalid input: the value of generate_series start can't be NULL
drop table t1;
create table t1(a datetime,b datetime,c varchar);
insert into t1 values('2020-02-28 00:00:00','2021-03-01 00:01:00', NULL);
select * from t1 cross apply generate_series(t1.a,t1.b,t1.c)g;
invalid input: generate_series datetime step can't be NULL
drop database join_test;
