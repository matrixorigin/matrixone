drop database if exists test_null_merge;
create database test_null_merge;
use test_null_merge;
create table payout_template (
batch_id int,
region varchar(8),
total_count int,
payout_amount decimal(12,2),
approved_at timestamp,
reviewer varchar(20),
comments varchar(50),
review_hash varbinary(6),
escalation_reason varchar(40),
primary key(batch_id)
);
insert into payout_template values
(10, 'east', 5, 1200.50, '2024-02-28 08:30:00', 'amy', 'baseline review', x'AAAA11', null),
(20, 'west', 3, null, null, null, 'requires data', null, 'missing invoices'),
(30, null, 7, 4800.00, '2024-02-28 10:00:00', 'leo', null, x'BBBB22', 'stale approvals');
data branch create table payout_stage from payout_template;
data branch create table payout_ops from payout_template;
update payout_stage
set payout_amount = null,
reviewer = null,
escalation_reason = 'manual hold'
where batch_id = 10;
update payout_stage
set approved_at = '2024-03-01 12:00:00',
reviewer = 'nina',
comments = null
where batch_id = 20;
insert into payout_stage values
(40, 'north', null, 2500.00, null, null, 'ad-hoc bonus', null, null);
update payout_ops
set payout_amount = 1250.75,
comments = 'auto adjusted',
review_hash = null
where batch_id = 10;
update payout_ops
set total_count = null,
payout_amount = null,
escalation_reason = null
where batch_id = 30;
insert into payout_ops values
(50, 'south', 2, null, null, 'kai', null, x'CCCC33', 'new workflow');
data branch diff payout_stage against payout_ops;
diff payout_stage against payout_ops    flag    batch_id    region    total_count    payout_amount    approved_at    reviewer    comments    review_hash    escalation_reason
payout_stage    UPDATE    10    east    5    null    2024-02-28 08:30:00    null    baseline review    ��    manual hold
payout_ops    UPDATE    10    east    5    1250.75    2024-02-28 08:30:00    amy    auto adjusted    null    null
payout_stage    UPDATE    20    west    3    null    2024-03-01 12:00:00    nina    null    null    missing invoices
payout_ops    UPDATE    30    null    null    null    2024-02-28 10:00:00    leo    null    ��"    null
payout_stage    INSERT    40    north    null    2500.00    null    null    ad-hoc bonus    null    null
payout_ops    INSERT    50    south    2    null    null    kai    null    ��3    new workflow
data branch merge payout_stage into payout_ops;
internal error: conflict: payout_stage UPDATE and payout_ops UPDATE on pk(10) with different values
data branch merge payout_stage into payout_ops when conflict skip;
select batch_id, region, total_count, payout_amount, reviewer, escalation_reason
from payout_ops
order by batch_id;
batch_id    region    total_count    payout_amount    reviewer    escalation_reason
10    east    5    1250.75    amy    null
20    west    3    null    nina    missing invoices
30    null    null    null    leo    null
40    north    null    2500.00    null    null
50    south    2    null    kai    new workflow
data branch merge payout_stage into payout_ops when conflict accept;
select batch_id, region, total_count, payout_amount, reviewer, escalation_reason
from payout_ops
order by batch_id;
batch_id    region    total_count    payout_amount    reviewer    escalation_reason
10    east    5    null    null    manual hold
20    west    3    null    nina    missing invoices
30    null    null    null    leo    null
40    north    null    2500.00    null    null
50    south    2    null    kai    new workflow
drop table payout_template;
drop table payout_stage;
drop table payout_ops;
create table audit_left (
job_id int,
shard char(3),
seq int,
checksum varbinary(4),
status varchar(8),
payload varchar(20),
metric decimal(8,3),
event_time timestamp,
primary key(job_id, shard)
);
insert into audit_left values
(101, 'a01', 1, x'AA11', 'open', 'inventory gap', null, '2024-03-02 09:00:00'),
(102, 'b02', null, null, 'pending', null, 1.250, '2024-03-02 10:30:00'),
(103, 'c03', 5, x'BB22', 'closed', 'retry', null, null);
create table audit_right (
job_id int,
shard char(3),
seq int,
checksum varbinary(4),
status varchar(8),
payload varchar(20),
metric decimal(8,3),
event_time timestamp,
primary key(job_id, shard)
);
insert into audit_right values
(101, 'a01', 2, null, null, 'inventory gap', 0.750, '2024-03-03 11:00:00'),
(103, 'c03', 5, x'BB22', 'closed', 'retry', 1.500, '2024-03-02 08:30:00'),
(104, 'd04', 1, x'CC33', 'open', null, null, null);
data branch diff audit_right against audit_left;
diff audit_right against audit_left    flag    job_id    shard    seq    checksum    status    payload    metric    event_time
audit_left    INSERT    101    a01    1    �    open    inventory gap    null    2024-03-02 09:00:00
audit_right    INSERT    101    a01    2    null    null    inventory gap    0.750    2024-03-03 11:00:00
audit_left    INSERT    102    b02    null    null    pending    null    1.250    2024-03-02 10:30:00
audit_left    INSERT    103    c03    5    �"    closed    retry    null    null
audit_right    INSERT    103    c03    5    �"    closed    retry    1.500    2024-03-02 08:30:00
audit_right    INSERT    104    d04    1    �3    open    null    null    null
data branch merge audit_right into audit_left when conflict skip;
select job_id, shard, seq, status, payload, metric
from audit_left
order by job_id, shard;
job_id    shard    seq    status    payload    metric
101    a01    1    open    inventory gap    null
102    b02    null    pending    null    1.250
103    c03    5    closed    retry    null
104    d04    1    open    null    null
data branch merge audit_right into audit_left when conflict accept;
select job_id, shard, seq, status, payload, metric
from audit_left
order by job_id, shard;
job_id    shard    seq    status    payload    metric
101    a01    2    null    inventory gap    0.750
102    b02    null    pending    null    1.250
103    c03    5    closed    retry    1.500
104    d04    1    open    null    null
drop table audit_left;
drop table audit_right;
drop database test_null_merge;
