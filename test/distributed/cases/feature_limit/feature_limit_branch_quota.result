drop account if exists fl_branch_acc;
create account fl_branch_acc admin_name = 'admin' identified by '111';
select mo_feature_registry_upsert(
'branch',
'Branch feature',
'{"allowed_scope":[]}',
true
);
mo_feature_registry_upsert(branch, Branch feature, {"allowed_scope":[]}, true)
{\n  "now": {\n    "feature_code": "BRANCH",\n    "description": "Branch feature",\n    "scope_spec": {\n      "allowed_scope": []\n    },\n    "enabled": true\n  },\n  "old": {\n    "feature_code": "BRANCH",\n    "description": "Branch feature",\n    "scope_spec": {\n      "allowed_scope": []\n    },\n    "enabled": true\n  }\n}\n
select mo_feature_registry_upsert(
'snapshot',
'Snapshot feature',
'{"allowed_scope":["account","database","table"]}',
true
);
mo_feature_registry_upsert(snapshot, Snapshot feature, {"allowed_scope":["account","database","table"]}, true)
{\n  "now": {\n    "feature_code": "SNAPSHOT",\n    "description": "Snapshot feature",\n    "scope_spec": {\n      "allowed_scope": ["account", "database", "table"]\n    },\n    "enabled": true\n  },\n  "old": {\n    "feature_code": "SNAPSHOT",\n    "description": "Snapshot feature",\n    "scope_spec": {\n      "allowed_scope": ["account", "database", "table"]\n    },\n    "enabled": true\n  }\n}\n
set @fl_branch_id = (select account_id from mo_catalog.mo_account where account_name = 'fl_branch_acc');
select mo_feature_limit_upsert(@fl_branch_id, 'snapshot', 'table', -1);
mo_feature_limit_upsert(@fl_branch_id, snapshot, table, -1)
{\n  "now": {\n    "account_id": 20001,\n    "feature_code": "SNAPSHOT",\n    "scope": "table",\n    "quota": -1\n  },\n  "old": null\n}\n
select mo_feature_limit_upsert(@fl_branch_id, 'branch', '', 1);
mo_feature_limit_upsert(@fl_branch_id, branch, , 1)
{\n  "now": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": 1\n  },\n  "old": null\n}\n
drop database if exists fl_branch_db;
create database fl_branch_db;
use fl_branch_db;
drop table if exists base;
create table base(a int primary key, b varchar(10));
insert into base values (1, 'a'), (2, 'b');
drop snapshot if exists sp_base;
create snapshot sp_base for table fl_branch_db base;
drop table if exists b1;
drop table if exists b2;
data branch create table b1 from base{snapshot='sp_base'};
data branch create table b2 from base{snapshot='sp_base'};
internal error: feature BRANCH with scope  has reached the limit of 1
data branch delete table fl_branch_db.b1;
data branch create table b2 from base{snapshot='sp_base'};
select mo_feature_limit_upsert(@fl_branch_id, 'branch', '', 0);
mo_feature_limit_upsert(@fl_branch_id, branch, , 0)
{\n  "now": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": 0\n  },\n  "old": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": 1\n  }\n}\n
drop table if exists b3;
data branch create table b3 from base{snapshot='sp_base'};
internal error: feature BRANCH with scope  has disabled for account fl_branch_acc
select mo_feature_limit_upsert(@fl_branch_id, 'branch', '', -1);
mo_feature_limit_upsert(@fl_branch_id, branch, , -1)
{\n  "now": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": -1\n  },\n  "old": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": 0\n  }\n}\n
drop table if exists b3;
drop table if exists b4;
data branch create table b3 from base{snapshot='sp_base'};
data branch create table b4 from base{snapshot='sp_base'};
drop snapshot sp_base;
drop table b2;
drop table b3;
drop table b4;
drop table base;
drop database fl_branch_db;
drop database if exists src_db;
create database src_db;
use src_db;
drop table if exists t1;
drop table if exists t2;
create table t1(a int primary key);
create table t2(a int primary key);
insert into t1 values (1);
insert into t2 values (2);
select mo_feature_limit_upsert(@fl_branch_id, 'branch', '', 1);
mo_feature_limit_upsert(@fl_branch_id, branch, , 1)
{\n  "now": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": 1\n  },\n  "old": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": -1\n  }\n}\n
drop database if exists dst_db;
data branch create database dst_db from src_db;
internal error: feature BRANCH with scope  has reached the limit of 1
select mo_feature_limit_upsert(@fl_branch_id, 'branch', '', 10);
mo_feature_limit_upsert(@fl_branch_id, branch, , 10)
{\n  "now": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": 10\n  },\n  "old": {\n    "account_id": 20001,\n    "feature_code": "BRANCH",\n    "scope": "",\n    "quota": 1\n  }\n}\n
data branch create database dst_db from src_db;
drop database dst_db;
drop database src_db;
drop account fl_branch_acc;
