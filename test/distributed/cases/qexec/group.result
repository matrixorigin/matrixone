drop database if exists qetest;
create database qetest;
use qetest;
create table t (a int, b int, c varchar(100), d decimal(10, 2), f real);
insert into t select
result, result % 1000,
case when result % 10 = 0 then null else 'foobar' || result || 'zoo' end,
case when result % 10 = 0 then null else result end,
case when result % 10 = 0 then null else result end
from generate_series(1, 1000000) gt;
select count(*) from t;
count(*)
1000000
insert into t select * from t;
select count(*) from t;
count(*)
2000000
select count(*), count(a), count(b), count(c),
avg(a), avg(b), avg(d), avg(f),
max(a), max(b), max(c), max(d), max(f)
from t;
count(*)    count(a)    count(b)    count(c)    avg(a)    avg(b)    avg(d)    avg(f)    max(a)    max(b)    max(c)    max(d)    max(f)
2000000    2000000    2000000    1800000    500000.5    499.5    500000.00000000    500000.0    1000000    999    foobar9zoo    999999.00    999999.0
select count(a), sum(d), sum(f) from (
select count(*), a, sum(d) as d, sum(f) as f from t group by a
) tmp;
count(a)    sum(d)    sum(f)
1000000    900000000000.00    9.0E11
select count(a), sum(d), sum(f) from (
select count(*), a, sum(d) as d, sum(f) as f from t group by a
having a % 100 > 95
) tmp;
count(a)    sum(d)    sum(f)
40000    40003800000.00    4.00038E10
select count(*) from (select a, b, c from t group by a, b, c) tmpt;
count(*)
1000000
select sum(a), max(c), avg(d), avg(f) from (select a, c, avg(d) as d, avg(f) as f from t group by a, c) tmpt;
sum(a)    max(c)    avg(d)    avg(f)
500000500000    foobar9zoo    500000.000000000000    500000.0
select count(a), sum(d), sum(f) from (
select count(*), a, sum(distinct d) d, sum(distinct f) f from t where a < 10000 group by a
) tmp;
count(a)    sum(d)    sum(f)
9999    45000000.00    4.5E7
select 'set max_dop to 1 ... ';
set max_dop to 1 ... 
set max_dop to 1 ... 
set @@max_dop = 1;
select 'set agg_spill_mem to 50MB ... ';
set agg_spill_mem to 50MB ... 
set agg_spill_mem to 50MB ... 
set @@agg_spill_mem = 60000000;
select count(*) from (select a, b, c from t group by a, b, c) tmpt;
count(*)
1000000
select sum(a), max(c), avg(d), avg(f) from (select a, c, avg(d) as d, avg(f) as f from t group by a, c) tmpt;
sum(a)    max(c)    avg(d)    avg(f)
500000500000    foobar9zoo    500000.000000000000    500000.0
select count(a), sum(d), sum(f) from (
select count(*), a, sum(distinct d) d, sum(distinct f) f from t where a < 10000 group by a
) tmp;
count(a)    sum(d)    sum(f)
9999    45000000.00    4.5E7
explain analyze select a, b, c from t group by a, b, c;
ap query plan on one cn(24 core)
Project
  Analyze: timeConsumed=0ms waitTime=0ms inputRows=1000000 outputRows=1000000 (min=1000000, max=1000000) InputSize=30.52 MiB OutputSize=30.52 MiB MemorySize=256.00 KiB (min=256.00 KiB, max=256.00 KiB)
  ->  Aggregate
        Analyze: timeConsumed=1390ms waitTime=0ms inputRows=0 outputRows=1000000 (min=1000000, max=1000000) InputSize=0 bytes OutputSize=30.52 MiB MemorySize=57.50 MiB (min=57.50 MiB, max=57.50 MiB) SpillSize=115.00 MiB (min=115.00 MiB, max=115.00 MiB)
        Group Key: t.a, t.b, t.c shuffle: range(t.a)
        ->  Table Scan on qetest.t
              Analyze: timeConsumed=9ms waitTime=0ms inputBlocks=246 inputRows=2000000 outputRows=2000000 (min=2000000, max=2000000) InputSize=61.04 MiB OutputSize=61.04 MiB MemorySize=512.00 KiB (min=512.00 KiB, max=512.00 KiB)
explain analyze select a, c, avg(d) d, avg(f) f from t group by a, c;
ap query plan on one cn(24 core)
Project
  Analyze: timeConsumed=0ms waitTime=0ms inputRows=1000000 outputRows=1000000 (min=1000000, max=1000000) InputSize=49.59 MiB OutputSize=49.59 MiB MemorySize=416.00 KiB (min=416.00 KiB, max=416.00 KiB)
  ->  Aggregate
        Analyze: timeConsumed=7202ms waitTime=0ms inputRows=0 outputRows=1000000 (min=1000000, max=1000000) InputSize=0 bytes OutputSize=49.59 MiB MemorySize=60.76 MiB (min=60.76 MiB, max=60.76 MiB) SpillSize=242.75 MiB (min=242.75 MiB, max=242.75 MiB)
        Group Key: t.a, t.c shuffle: range(t.a)
        Aggregate Functions: avg(t.d), avg(t.f)
        ->  Table Scan on qetest.t
              Analyze: timeConsumed=20ms waitTime=0ms inputBlocks=246 inputRows=2000000 outputRows=2000000 (min=2000000, max=2000000) InputSize=83.92 MiB OutputSize=83.92 MiB MemorySize=704.00 KiB (min=704.00 KiB, max=704.00 KiB)
explain analyze select count(*), a, sum(distinct d) d, sum(distinct f) f from t where a < 10000 group by a;
tp query plan
Project
  Analyze: timeConsumed=0ms waitTime=0ms inputRows=9999 outputRows=9999 (min=9999, max=9999) InputSize=351.53 KiB OutputSize=351.53 KiB MemorySize=288.00 KiB (min=288.00 KiB, max=288.00 KiB)
  ->  Aggregate
        Analyze: timeConsumed=558ms waitTime=0ms inputRows=19998 outputRows=9999 (min=9999, max=9999) InputSize=390.59 KiB OutputSize=351.53 KiB MemorySize=2.57 GiB (min=2.57 GiB, max=2.57 GiB)
        Group Key: t.a
        Aggregate Functions: starcount(1), sum(t.d), sum(t.f)
        ->  Table Scan on qetest.t
              Analyze: timeConsumed=0ms waitTime=0ms inputBlocks=4 inputRows=32768 outputRows=19998 (min=19998, max=19998) InputSize=640.00 KiB OutputSize=390.59 KiB MemorySize=315.75 KiB (min=123.75 KiB, max=160.00 KiB)
              Filter Cond: (t.a < 10000)
              Block Filter Cond: (t.a < 10000)
drop database qetest;
