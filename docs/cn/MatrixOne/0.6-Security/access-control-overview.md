# MatrixOne 中的权限控制 - 访问控制概述

MatrixOne 的权限控制是结合了基于角色的访问控制 (RBAC，Role-based access control) 和自主访问控制 (DAC，Discretionary access control) 两种安全模型设计和实现的，它既保证了数据访问的安全性，又给数据库运维人员提供了灵活且便捷的管理方法。

- 基于角色的访问控制（RBAC）：将权限分配给角色，再将角色分配给用户。

- 自主访问控制（DAC）：每个对象都有一个所有者，所有者可以设置和授予对该对象的访问权限。

## 基础概念

### 对象

对象是 MatrixOne 中封装权限的实体，这些实体之间具有一定的层次结构，例如一个集群（ Cluster ）包含多个 租户（Account），一个租户（Account）包含多个 用户（User）角色（ Role）， 数据库（Database），而一个数据库（Database） 包含多个表（ Table）， 视图（View） 等，这种层次结构如下图所示：

- 每个对象都有且只有一个所有者（Owner），反之，该所有者（Owner）拥有该对象的所有权（Ownership） 权限。

   !!! note
        - Owner 是针对某个具体的对象而不是一类对象，例如 Role_1 是 db1 的 Owner， Role_2 是 db2 的 Owner，Role_1 与 db2 并没有必然的权限所有关系。
        - 一个上层对象的 Owner 不一定具有下层对象的访问权限，例如 Role_1 是 db1 的 Owner，Role_2 创建了 db1.table1，则 Role_2 是 db1.table1 的 Owner，Role_1 无法查看它的数据。

- 对象的初始 Owner 是它的创建者，Owner 身份可以由 Owner 本身或具备高级权限控制的所有者发起转移。
- 如果对象的 Owner 被删除，则该对象的 Owner 自动变更为被删除者的 Owner。
- ACCOUNTADMIN 角色默认拥有所有对象的 Ownership 权限。
- 每种对象的访问权限集合不同。更多信息，参考[访问控制权限](access-control.md)。

### 角色

角色是拥有访问权限的实体，任何数据库用户想访问某一对象时，都必须先被授予具有访问该对象权限的角色。MatrixOne 的角色分为系统角色和用户自定义角色，系统首次启动或新建账号时会初始化一些系统默认角色，它们往往是最高的管理员角色和用户，不可以被修改和删除，用户可以根据业务需要，使用它们创建出更多的自定义角色来管理数据库。

- 一个角色可以被授予一个对象的多种访问权限。
- 一个角色可以被授予多个对象的访问权限。
- 角色间可以传递权限，通常有**授予**和**继承**两种方法。

   + **授予**：权限的授予具有一次授予永久生效的特性。例如*角色1*拥有权限 a， b， c； *角色2*拥有权限 d，此时将*角色1*的权限授予给*角色2*，则*角色2*拥有权限 a， b， c， d，当删除 角色1 后， *角色2*仍拥有权限 a， b， c， d。
   + **继承**：权限的继承具有动态传递的特性。例如*角色1*拥有权限 a， b， c； *角色3*拥有权限 e， f，可以指定*角色3*继承*角色1*，则*角色3*拥有权限 a， b， c， e， f； 当删除*角色1*后，*角色3*仅拥有权限 e， f。

     !!! note
          1.操作授予和继承的角色需要拥有对象的 Ownership 权限或某一高级授予权限。
          2.角色的继承关系不能成环。

- 在 MatrixOne 中，实现了租户间权限隔离，即 Account 内的角色和用户仅在该 Account 内生效，不会影响和传递给其他 Account，角色之间的授权也仅限在 Account 内。

### 角色切换

用户想要获取某一个对象的访问权限时，需要先将权限授予给一个角色，再将角色授予给该用户。用户可以拥有多个角色，但同一时刻该用户只能使用一个角色来访问数据库，我们称这个角色为**主要角色**，其余的角色为**次要角色**。用户在执行某条或某些 SQL 时，系统会判定主要角色是否具有执行 SQL 所需的权限，再决定是否执行 SQL。

在某些场景下（如管理员并没有很好的建立完善的角色体系），一条 SQL 需要结合多个角色的权限才能执行，MatrixOne 提供使用次要角色的功能来帮助这类用户完成查询：

```sql
use secondary role { all | none }
```

默认值为 `all`。若选择使用 `all`，则所有次要角色的权限都可以提供给用户使用；若选择使用 `none`，则只能使用主要角色的权限。

### 对象删除

删除租户时，需要先冻结租户，即需要执行 `close` 或 `suspend`。
删除角色时，会强制对所有已经授权的角色进行权限回收，即需要执行 `revoke`。
删除用户时，如果该用户当前存在会话，则删除用户失败。

## 初始化访问控制

为方便管理，在集群或账户被创建后，系统会自动生成一些**默认用户**和**默认角色**。

#### 默认用户

|用户名|描述|
|---|---|
|root|集群创建后自动创建且被授予 MOADMIN 角色，不可修改或删除|
|admin|Account 创建后自动创建且被授予 ACCOUNTADMIN 角色，不可修改或删除|

#### 默认角色

|用户名|描述|
|---|---|
|MOADMIN|集群初始化后自动创建的超级管理员角色，不可修改或删除。|
|ACCOUNTADMIN|Account 创建初始化后自动创建，是该 ACCOUNT 的超级管理员角色|
|PUBLIC|Account 创建后自动创建，该 Account 下所有用户被创建时均会被加到 PUBLIC 角色下，用户不能被移除。PUBLIC 角色的初始权限为CONNECT。|
